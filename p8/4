import numpy as np
import matplotlib.pyplot as plt
from scipy.signal import butter, lfilter
from scipy.fft import fft, fftfreq

# --- Parâmetros do Ex. 4 ---
Fs = 44100
T = 2.0
t = np.linspace(0.0, T, int(Fs * T), endpoint=False)

Fc_ex4 = 15000  # Portadora: 15 kHz
Fm_original = 2000 # Sinal de informação até 2 kHz (que será limitado)

# Requisito de Banda: 14 kHz a 16 kHz => Fm_max deve ser 1 kHz
F_corte_filtro = 1000 # 1 kHz

# --- Funções Auxiliares (Reutilizadas) ---
def gerar_sinal_informacao(t, freq_max):
    # Gera um sinal que tem componentes até freq_max
    return 0.5 * np.cos(2 * np.pi * freq_max * t)

def gerar_portadora(t, fc):
    return 1.0 * np.sin(2 * np.pi * fc * t)

def filtro_passa_baixa(sinal, corte_hz, Fs, ordem=5):
    nyquist = 0.5 * Fs
    corte_normalizado = corte_hz / nyquist
    b, a = butter(ordem, corte_normalizado, btype='low', analog=False)
    y = lfilter(b, a, sinal)
    return y

def plotar_espectro_fft(sinal, Fs, titulo, cor='blue'):
    N = len(sinal)
    yf = fft(sinal)
    xf = fftfreq(N, 1/Fs)
    xf_positive = xf[:N//2]
    yf_positive = 2.0/N * np.abs(yf[:N//2])

    plt.figure(figsize=(10, 4))
    plt.plot(xf_positive / 1000, yf_positive, color=cor)
    plt.title(titulo)
    plt.xlabel('Frequência (kHz)')
    plt.ylabel('Magnitude |Y(f)|')
    # Destaca a banda permitida (14 a 16 kHz)
    plt.axvspan(14, 16, color='red', alpha=0.2, label='Banda Permitida')
    plt.xlim(0, 20)
    plt.legend()
    plt.grid()
    plt.show()

# --- Execução do Ex. 4 ---
m_t_original = gerar_sinal_informacao(t, Fm_original)
C_t = gerar_portadora(t, Fc_ex4)

# Ação: Filtrar o sinal de informação para limitar sua frequência máxima
m_t_filtrado = filtro_passa_baixa(m_t_original, F_corte_filtro, Fs)

# Modulação com o sinal filtrado
S_modulado_filtrado = m_t_filtrado * C_t

print("--- Execução do Exercício 4: Filtragem Prévia ---")
print(f"Portadora (Fc): {Fc_ex4/1000:.1f} kHz")
print(f"Banda Permitida: 14 kHz a 16 kHz.")
print(f"Frequência Máxima Necessária (Fm <= 1kHz): {F_corte_filtro/1000:.1f} kHz")

plotar_espectro_fft(S_modulado_filtrado, Fs, f'Ex. 4: Espectro AM após Filtragem (Ajustado à Banda 14-16 kHz)', cor='orange')